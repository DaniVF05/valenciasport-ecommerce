<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ValenciaSport - E-Commerce</title>
    
    <link rel="icon" type="image/png" href="/favicon.png"> 
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f5f5f5; font-family: system-ui, -apple-system, sans-serif; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .product-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-4px); }
        .product-card img { width: 100%; height: 200px; object-fit: cover; border-radius: 4px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #ff5722; color: white; }
        .btn-primary:hover { background: #e64a19; }
        .cart { position: fixed; right: 0; top: 0; width: 400px; height: 100vh; background: white; box-shadow: -2px 0 8px rgba(0,0,0,0.2); transform: translateX(100%); transition: transform 0.3s; z-index: 1000; }
        .cart.open { transform: translateX(0); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 999; }
        .overlay.show { display: block; }
        
        .category-nav-item { padding: 8px 16px; margin: 0 5px; border-radius: 20px; cursor: pointer; transition: background 0.2s, color 0.2s; font-weight: 500; color: #555; }
        .category-nav-item.active { background: #ff5722; color: white; font-weight: 600; }
        .category-nav-item:hover { background: #ffe0b2; }
        
        /* Modal de Detalle del Producto */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #ddd; }
        .modal-body { padding: 30px; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #666; }
        
        /* Barra de B√∫squeda */
        .search-bar { display: flex; gap: 10px; max-width: 500px; }
        .search-bar input { flex: 1; padding: 10px 16px; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; }
        
        /* Filtros y Ordenamiento */
        .filters { background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .filters select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        
        /* Load More Button */
        .load-more-container { text-align: center; margin-top: 30px; }
        
        @media (max-width: 768px) {
            .modal-content { width: 95%; }
            .modal-body > div { grid-template-columns: 1fr !important; }
            .cart { width: 100%; }
            .search-bar { max-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay" onclick="cerrarCarrito()"></div>
    
    <div class="header">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <h1 style="font-size: 28px; font-weight: 700; color: #333;">‚ö° ValenciaSport</h1>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="üîç Buscar productos..." onkeyup="buscarProductos()">
            </div>
            <button onclick="toggleCarrito()" class="btn btn-primary" id="btnCarrito">
                üõí Carrito (<span id="cartCount">0</span>)
            </button>
        </div>
    </div>

    <div style="background: white; padding: 10px 0; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
        <div class="container" style="display: flex; justify-content: center; flex-wrap: wrap;" id="categoryNav">
            <span class="category-nav-item active" onclick="setCategoriaActiva('Todos')">Todos</span>
        </div>
    </div>

    <div class="container">
        <div class="filters">
            <label style="font-weight: 600;">Ordenar por:</label>
            <select id="sortSelect" onchange="aplicarOrdenamiento()">
                <option value="">Sin ordenar</option>
                <option value="precio-asc">Precio: Menor a Mayor</option>
                <option value="precio-desc">Precio: Mayor a Menor</option>
                <option value="rating-desc">Rating: Mayor a Menor</option>
                <option value="ventas-desc">M√°s Vendidos</option>
            </select>
        </div>
        
        <div id="productos" class="product-grid"></div>
        <div class="load-more-container" id="loadMoreContainer" style="display: none;">
            <button onclick="cargarMasProductos()" class="btn btn-primary" id="loadMoreBtn">‚è¨ Cargar M√°s Productos</button>
        </div>
        <div id="loading" style="text-align: center; padding: 60px;">
            <p style="font-size: 48px;">‚è≥</p>
            <p style="font-size: 20px; margin-top: 16px;">Cargando productos...</p>
        </div>
        <div id="error" style="display: none; text-align: center; padding: 60px;">
            <p style="font-size: 48px;">‚ùå</p>
            <p style="font-size: 20px; margin-top: 16px; color: #d32f2f;">Error de Conexi√≥n o Carga</p>
            <p style="margin-top: 8px; color: #666;">Revisa la consola (F12) para m√°s detalles o verifica el nombre de la tabla.</p>
            <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">Reintentar</button>
        </div>
    </div>

    <div class="cart" id="cart">
        <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size: 20px; font-weight: 700;">üõí Tu Carrito</h2>
            <button onclick="cerrarCarrito()" style="background: none; border: none; font-size: 24px; cursor: pointer;">‚úï</button>
        </div>
        <div id="cartItems" style="padding: 20px; overflow-y: auto; height: calc(100vh - 200px);"></div>
        <div style="padding: 20px; border-top: 1px solid #ddd;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 16px; font-size: 18px; font-weight: 700;">
                <span>Total:</span>
                <span id="cartTotal">$0.00</span>
            </div>
            <button onclick="finalizarCompra()" class="btn btn-primary" style="width: 100%;">Finalizar Compra</button>
        </div>
    </div>

    <!-- Modal de Detalle del Producto -->
    <div class="modal" id="productModal" onclick="cerrarModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle" style="font-size: 24px; font-weight: 700;">Detalle del Producto</h2>
                <button class="modal-close" onclick="cerrarModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wzbqrletyfybalxrhwuu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6YnFybGV0eWZ5YmFseHJod3V1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NTgzMjksImV4cCI6MjA3NjIzNDMyOX0.QudV22Ma8TzPaIRHVT2onElsJ3r39TLBnexOIFOv7BA';
        
        console.log('Iniciando app...');
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let carrito = [];
        let productos = [];
        let categoriaActiva = 'Todos';
        let productosMostrados = 12; // Para paginaci√≥n
        let terminoBusqueda = '';
        let ordenamiento = '';

        // Cargar carrito desde localStorage al iniciar
        function cargarCarritoDesdeStorage() {
            try {
                const carritoGuardado = localStorage.getItem('valenciasport_carrito');
                if (carritoGuardado) {
                    carrito = JSON.parse(carritoGuardado);
                    actualizarCarrito();
                }
            } catch (e) {
                console.error('Error al cargar carrito:', e);
            }
        }

        // Guardar carrito en localStorage
        function guardarCarritoEnStorage() {
            try {
                localStorage.setItem('valenciasport_carrito', JSON.stringify(carrito));
            } catch (e) {
                console.error('Error al guardar carrito:', e);
            }
        }

        const IMAGE_URL_MAP = {
            'zapatillas': 'https://i1.t4s.cz//products/BB6161/ultraboost-x-124296-bb6161-960.jpg',
            'balon': 'https://fairplaybo.vtexassets.com/arquivos/ids/518277/je8770.jpg?v=638773943063370000',
            'guantes': 'https://m.media-amazon.com/images/I/71eilZDrgWL._AC_SL1500_.jpg',
            'mochila': 'https://images-cdn.ubuy.com.pl/68d694460431e115910722c3-nike-elite-pro-basketball-backpack-black.jpg',
            'camiseta': 'https://acdn-us.mitiendanube.com/stores/144/702/products/remera-hombre-dry-fit-negra-reusch-gris-frente-7955656dbadd092ab817151959554041-1024-1024.jpg',
            'short': 'https://freshapparelpty.com/cdn/shop/files/short-deportivo-reebok-logo-y-zipper-ajustados.png?v=1751321031',
            'botines': 'https://newsport.vtexassets.com/arquivos/ids/20118342-800-auto?v=638779819379100000&width=800&height=auto&aspect=true',
            'reloj': 'https://istarmax.com/wp-content/uploads/2022/01/s5-black-1024x1024.jpg',
        };
        
        function getImageUrl(product) {
            if (product.imagen && product.imagen.startsWith('http')) {
                return product.imagen;
            }
            const clave = (product.categoria || product.nombre || '').toLowerCase().trim();
            return IMAGE_URL_MAP[clave] || 'https://placehold.co/300x200?text=SIN+IMAGEN';
        }

        async function cargarProductos() {
            try {
                console.log('Conectando con Supabase...');
                
                const { data, error } = await supabaseClient
                    .from('productos')
                    .select('*');

                console.log('Respuesta:', { data, error });

                if (error) throw error;

                if (!data || data.length === 0) {
                    throw new Error('No hay productos en la base de datos o RLS no permite leer.');
                }

                productos = data;
                console.log('Productos cargados:', productos.length);
                
                generarMenuCategorias();
                mostrarProductos();
                
            } catch (err) {
                console.error('Error al cargar productos:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }
        
        function generarMenuCategorias() {
            const categorias = [...new Set(productos.map(p => p.categoria))].filter(c => c && c.trim() !== '');
            const nav = document.getElementById('categoryNav');
            
            categorias.forEach(cat => {
                const item = document.createElement('span');
                item.className = 'category-nav-item';
                item.textContent = cat;
                item.onclick = () => setCategoriaActiva(cat);
                nav.appendChild(item);
            });
        }
        
        function setCategoriaActiva(nuevaCategoria) {
            categoriaActiva = nuevaCategoria;
            productosMostrados = 12; // Reset al cambiar categor√≠a
            
            document.querySelectorAll('#categoryNav .category-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.textContent === nuevaCategoria) {
                    item.classList.add('active');
                }
            });
            
            mostrarProductos();
        }

        // Nueva funci√≥n: B√∫squeda de productos
        function buscarProductos() {
            terminoBusqueda = document.getElementById('searchInput').value.toLowerCase().trim();
            productosMostrados = 12; // Reset
            mostrarProductos();
        }

        // Nueva funci√≥n: Aplicar ordenamiento
        function aplicarOrdenamiento() {
            ordenamiento = document.getElementById('sortSelect').value;
            mostrarProductos();
        }

        // Nueva funci√≥n: Cargar m√°s productos (paginaci√≥n)
        function cargarMasProductos() {
            productosMostrados += 12;
            mostrarProductos();
        }

        function mostrarProductos() {
            document.getElementById('loading').style.display = 'none';
            const container = document.getElementById('productos');
            
            // Filtrar por categor√≠a
            let productosFiltrados = categoriaActiva === 'Todos'
                ? productos
                : productos.filter(p => p.categoria === categoriaActiva);
            
            // Filtrar por b√∫squeda
            if (terminoBusqueda) {
                productosFiltrados = productosFiltrados.filter(p => 
                    (p.nombre || '').toLowerCase().includes(terminoBusqueda) ||
                    (p.descripcion || '').toLowerCase().includes(terminoBusqueda) ||
                    (p.categoria || '').toLowerCase().includes(terminoBusqueda)
                );
            }
            
            // Aplicar ordenamiento
            if (ordenamiento) {
                switch(ordenamiento) {
                    case 'precio-asc':
                        productosFiltrados.sort((a, b) => parseFloat(a.precio) - parseFloat(b.precio));
                        break;
                    case 'precio-desc':
                        productosFiltrados.sort((a, b) => parseFloat(b.precio) - parseFloat(a.precio));
                        break;
                    case 'rating-desc':
                        productosFiltrados.sort((a, b) => parseFloat(b.rating || 0) - parseFloat(a.rating || 0));
                        break;
                    case 'ventas-desc':
                        productosFiltrados.sort((a, b) => parseInt(b.ventas || 0) - parseInt(a.ventas || 0));
                        break;
                }
            }
                
            if (productosFiltrados.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px;"><p style="font-size: 24px;">No hay productos disponibles.</p></div>';
                document.getElementById('loadMoreContainer').style.display = 'none';
                return;
            }
            
            // Aplicar paginaci√≥n
            const productosParaMostrar = productosFiltrados.slice(0, productosMostrados);
            
            container.innerHTML = productosParaMostrar.map(p => {
                const imageUrl = getImageUrl(p);
                const productJsonString = JSON.stringify(p).replace(/'/g, "\\'");
                
                return `
                    <div class="product-card" onclick='abrirModalDetalle(${productJsonString})'>
                        <img src="${imageUrl}" alt="${p.nombre}" onerror="this.src='https://placehold.co/300x200/cccccc/333333?text=Sin+Imagen'">
                        <div style="margin-top: 12px;">
                            <div style="background: #ff5722; color: white; display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-bottom: 8px;">${p.categoria}</div>
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">${p.nombre}</h3>
                            <p style="font-size: 13px; color: #666; margin-bottom: 8px; height: 40px; overflow: hidden;">${p.descripcion || 'Sin descripci√≥n disponible.'}</p>
                            <div style="color: #ffa500; font-size: 14px; margin-bottom: 8px;">‚≠ê ${p.rating || 'N/A'} (${p.ventas || 0} vendidos)</div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 24px; font-weight: 700; color: #ff5722;">$${parseFloat(p.precio || 0).toFixed(2)}</span>
                                <button onclick='event.stopPropagation(); agregarAlCarrito(${productJsonString})' class="btn btn-primary">A√±adir</button>
                            </div>
                            <div style="margin-top: 8px; font-size: 12px; color: ${p.stock < 30 ? '#d32f2f' : '#4caf50'};">Stock: ${p.stock || 0}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Mostrar/ocultar bot√≥n "Cargar M√°s"
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (productosFiltrados.length > productosMostrados) {
                loadMoreContainer.style.display = 'block';
                document.getElementById('loadMoreBtn').textContent = `‚è¨ Cargar M√°s (${productosFiltrados.length - productosMostrados} restantes)`;
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }

        function agregarAlCarrito(producto) {
            console.log('Agregando:', producto);
            const existe = carrito.find(item => item.id === producto.id);
            
            if (existe) {
                existe.cantidad++;
            } else {
                carrito.push({ ...producto, cantidad: 1 });
            }
            
            guardarCarritoEnStorage(); // Guardar en localStorage
            actualizarCarrito();
            
            const btn = event.target;
            btn.textContent = '‚úì Agregado';
            setTimeout(() => btn.textContent = 'A√±adir', 1000);
        }

        // Nueva funci√≥n: Abrir modal de detalle del producto
        function abrirModalDetalle(producto) {
            const modal = document.getElementById('productModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = producto.nombre;
            
            const imageUrl = getImageUrl(producto);
            const productJsonString = JSON.stringify(producto).replace(/'/g, "\\'");
            
            modalBody.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <img src="${imageUrl}" style="width: 100%; border-radius: 8px; margin-bottom: 15px;" 
                             onerror="this.src='https://placehold.co/400x400/cccccc/333333?text=Sin+Imagen'">
                        <div style="background: #ff5722; color: white; display: inline-block; padding: 6px 12px; border-radius: 4px; font-weight: 600;">
                            ${producto.categoria}
                        </div>
                    </div>
                    <div>
                        <h3 style="font-size: 28px; font-weight: 700; margin-bottom: 15px; color: #333;">${producto.nombre}</h3>
                        <p style="font-size: 16px; color: #666; margin-bottom: 20px; line-height: 1.6;">
                            ${producto.descripcion || 'Producto de alta calidad para tus necesidades deportivas.'}
                        </p>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="color: #ffa500; font-size: 20px;">‚≠ê ${producto.rating || 'N/A'}</div>
                            <div style="color: #666; font-size: 16px;">(${producto.ventas || 0} vendidos)</div>
                        </div>
                        <div style="font-size: 36px; font-weight: 700; color: #ff5722; margin-bottom: 20px;">
                            $${parseFloat(producto.precio || 0).toFixed(2)}
                        </div>
                        <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">Disponibilidad:</div>
                            <div style="font-size: 18px; color: ${producto.stock < 30 ? '#d32f2f' : '#4caf50'}; font-weight: 600;">
                                ${producto.stock > 0 ? `${producto.stock} unidades disponibles` : 'Sin stock'}
                            </div>
                        </div>
                        <button onclick='agregarAlCarrito(${productJsonString}); cerrarModal();' 
                                class="btn btn-primary" 
                                style="width: 100%; padding: 15px; font-size: 18px;">
                            üõí Agregar al Carrito
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('show');
        }

        // Nueva funci√≥n: Cerrar modal
        function cerrarModal(event) {
            if (!event || event.target.id === 'productModal') {
                document.getElementById('productModal').classList.remove('show');
            }
        }

        function actualizarCarrito() {
            const count = carrito.reduce((sum, item) => sum + item.cantidad, 0);
            const total = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            
            document.getElementById('cartCount').textContent = count;
            document.getElementById('cartTotal').textContent = '$' + total.toFixed(2);
            
            const container = document.getElementById('cartItems');
            
            if (carrito.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><p style="font-size: 48px;">üõí</p><p style="margin-top: 16px;">Carrito vac√≠o</p></div>';
            } else {
                container.innerHTML = carrito.map(item => `
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
                        <img src="${getImageUrl(item)}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${item.nombre}</div>
                            <div style="color: #ff5722; font-weight: 700;">$${parseFloat(item.precio).toFixed(2)}</div>
                            <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
                                <button onclick="cambiarCantidad(${item.id}, -1)" class="btn" style="padding: 4px 12px; background: #ddd;">‚àí</button>
                                <span style="font-weight: 600;">${item.cantidad}</span>
                                <button onclick="cambiarCantidad(${item.id}, 1)" class="btn" style="padding: 4px 12px; background: #ddd;">+</button>
                            </div>
                        </div>
                        <button onclick="eliminarDelCarrito(${item.id})" style="background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 20px;">üóëÔ∏è</button>
                    </div>
                `).join('');
            }
        }

        function cambiarCantidad(id, cambio) {
            const item = carrito.find(i => i.id === id);
            if (item) {
                item.cantidad += cambio;
                if (item.cantidad <= 0) {
                    eliminarDelCarrito(id);
                } else {
                    guardarCarritoEnStorage(); // Guardar cambios
                    actualizarCarrito();
                }
            }
        }

        function eliminarDelCarrito(id) {
            carrito = carrito.filter(item => item.id !== id);
            guardarCarritoEnStorage(); // Guardar cambios
            actualizarCarrito();
        }

        function toggleCarrito() {
            document.getElementById('cart').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('show');
        }

        function cerrarCarrito() {
            document.getElementById('cart').classList.remove('open');
            document.getElementById('overlay').classList.remove('show');
        }

        function finalizarCompra() {
            if (carrito.length === 0) {
                alert('El carrito est√° vac√≠o');
                return;
            }
            
            const total = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            alert(`¬°Compra exitosa! üéâ\nTotal: $${total.toFixed(2)}\n\nGracias por tu compra en ValenciaSport`);
            
            // Opcional: Aqu√≠ podr√≠as guardar el pedido en Supabase
            // await guardarPedidoEnSupabase(carrito, total);
            
            carrito = [];
            guardarCarritoEnStorage(); // Limpiar localStorage
            actualizarCarrito();
            cerrarCarrito();
        }

        // Inicializar: cargar carrito guardado
        cargarCarritoDesdeStorage();
        cargarProductos();
    </script>
</body>
</html>
